default_platform(:android)

platform :android do
  desc "Deploy Flutter APK to Firebase App Distribution"
  lane :firebase_distribution do
    begin
      # Variables (SANS TOKEN EN DUR !)
      app_id = "1:1032200431495:android:367c351d3396ce57521522"
      testers = "myahmedelamiri@gmail.com,lailaelamiri586@gmail.com"
      
      puts "ğŸš€ Starting Flutter Firebase Distribution..."
      
      # Ã‰tape 1: Clean
      puts "ğŸ§¹ Cleaning project..."
      sh "flutter clean"
      
      # Ã‰tape 2: Build APK
      puts "ğŸ“¦ Building APK..."
      sh "flutter build apk --release --flavor production --target lib/main_production.dart --no-tree-shake-icons"
      
      # Ã‰tape 3: VÃ©rifier l'APK
      apk_path = "../build/app/outputs/flutter-apk/app-production-release.apk"
      
      unless File.exist?(apk_path)
        UI.error "APK not found at: #{apk_path}"
        raise "Build failed - APK not found"
      end
      
      puts "âœ… APK found: #{apk_path}"
      
      # Ã‰tape 4: Distribution Firebase (TOKEN SÃ‰CURISÃ‰)
      puts "ğŸ“¤ Deploying to Firebase App Distribution..."
      firebase_app_distribution(
        app: app_id,
        apk_path: apk_path,
        firebase_cli_token: ENV["FIREBASE_CLI_TOKEN"],  # â† VARIABLE D'ENVIRONNEMENT
        testers: testers,
        release_notes: "Auto-deploy from Fastlane - #{Time.now.strftime('%Y-%m-%d %H:%M')}",
        debug: true
      )
      
      puts "âœ… Successfully deployed to Firebase App Distribution!"
      
    rescue => error
      UI.error "âŒ Deployment failed: #{error.message}"
      raise error
    end
  end
end